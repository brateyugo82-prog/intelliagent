from PIL import Image, ImageOps
from pathlib import Path
from datetime import date
import shutil
from backend.backend.core.logger import logger


def trim_transparency(img: Image.Image) -> Image.Image:
    """
    Entfernt transparente R√§nder vom Logo
    """
    bbox = img.getbbox()
    if bbox:
        return img.crop(bbox)
    return img


def apply_branding(
    image_path: str,
    brand_ctx: dict,
    image_context: str,
    platform: str,
    run_date: date,
) -> str:
    """
    Branding-Pipeline (FOUNDATION + WEEKLY, FINAL)

    WEEKLY:
    - Quelle: output/approved/
    - Original ‚Üí used/
    - Kein Reuse

    FOUNDATION:
    - Quelle: assets/foundation/
    - Original BLEIBT UNVER√ÑNDERT
    - Kein used/, kein Rotate, kein Reuse
    """

    image_path = Path(image_path)
    image_path_str = str(image_path)

    # ------------------------------------------------
    # üîí MODE ERKENNEN
    # ------------------------------------------------
    is_weekly = "/approved/" in image_path_str
    is_foundation = "/assets/foundation/" in image_path_str

    # SOURCE CHECK DISABLED
    pass

    if is_weekly and "/used/" in image_path_str:
        raise ValueError(
            "[BrandingRenderer] ‚ùå USED-Bilder d√ºrfen NICHT erneut gebrandet werden"
        )

    mode = "FOUNDATION" if is_foundation else "WEEKLY"
    logger.info(f"[BrandingRenderer] üîç Mode erkannt: {mode}")

    # ------------------------------------------------
    # üñº BASISBILD LADEN
    # ------------------------------------------------
    img = ImageOps.exif_transpose(Image.open(image_path))
    if img.mode != "RGB":
        img = img.convert("RGB")
    width, height = img.size

    BACKEND_ROOT = Path(__file__).resolve().parents[1]

    # ------------------------------------------------
    # üé® LOGO-PFAD
    # ------------------------------------------------
    logo_path = (
        BACKEND_ROOT
        / "clients"
        / brand_ctx["client_name"]
        / "branding"
        / "logo.png"
    )

    if not logo_path.exists():
        logger.error(f"[BrandingRenderer] ‚ùå Logo fehlt: {logo_path}")
        raise FileNotFoundError(logo_path)

    
    # ------------------------------------------------
    # üßº LOGO LADEN (BANNER, FULL WIDTH)
    # ------------------------------------------------
    logo = Image.open(logo_path).convert("RGBA")

    # ------------------------------------------------
    # üìê BANNER / LOGO ‚Äì VOLLE BREITE
    # ------------------------------------------------
    BANNER_HEIGHT = int(height * 0.10)  # exakt wie vorher

    logo = logo.resize(
        (width, BANNER_HEIGHT),
        Image.LANCZOS,
    )

    # ------------------------------------------------
    # üìç POSITION ‚Äì UNTEN, LINKS ‚Üí RECHTS
    # ------------------------------------------------
    x = 0
    y = height - BANNER_HEIGHT

    img.paste(logo, (x, y), logo)


    # ------------------------------------------------
    # üíæ OUTPUT
    # ------------------------------------------------
    # ------------------------------------------------
    # üíæ OUTPUT (IMAGES ‚Üí PREVIEW)
    # ------------------------------------------------
    if "/images/" in image_path_str:
        output_dir = (
            BACKEND_ROOT
            / "clients"
            / brand_ctx["client_name"]
            / "output"
            / "preview"
        )
    else:
        output_dir = (
            BACKEND_ROOT
            / "clients"
            / brand_ctx["client_name"]
            / "output"
            / "branded"
            / run_date.isoformat()
            / platform
        )

    output_dir.mkdir(parents=True, exist_ok=True)
    branded_path = output_dir / image_path.name

    img.save(branded_path, "JPEG", quality=95, subsampling=0)

    logger.info(f"[BrandingRenderer] ‚úÖ Branding gespeichert ‚Üí {branded_path}")

    # ------------------------------------------------
    # üì¶ NUR WEEKLY ‚Üí ORIGINAL NACH used/
    # ------------------------------------------------
    if is_weekly:
        used_dir = image_path.parent / "used"
        used_dir.mkdir(exist_ok=True)

        target_used_path = used_dir / image_path.name
        shutil.move(str(image_path), target_used_path)

        logger.info(
            f"[BrandingRenderer] üì¶ WEEKLY Original verschoben ‚Üí {target_used_path}"
        )
    else:
        logger.info(
            "[BrandingRenderer] üîí FOUNDATION Bild bleibt unver√§ndert (kein used/)"
        )

    return str(branded_path)
